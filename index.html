<!DOCTYPE html>
<html>
<head>
  <title>HTML Form HTTP Extensions</title>
  <meta charset='utf-8'>
  <script src='http://www.w3.org/Tools/respec/respec-w3c-common' class='remove'></script>
  <script class='remove'>
    var respecConfig = {
        specStatus:   "unofficial",
        shortName:    "form-http-extensions",

        edDraftURI:      "http://cameronjones.github.com/form-http-extensions/index.html",

        // editors, add as many as you like
        // only "name" is required
        editors:  [
            { name: "Cameron Jones", url: "http://www.cmhjones.com/" },
        ],

        overrideCopyright: "<p class='copyright'>This document is licensed under a <a class='subfoot' rel='license' href='http://creativecommons.org/publicdomain/zero/1.0/'>Creative Commons Zero (CC0) Universal Public Domain Declaration</a>",

        wg:           "HTML Working Group",
        wgURI:        "http://www.w3.org/html/wg/",
        wgPublicList: "public-html",
        wgPatentURI:  "XXX"
    };
  </script>
  <style type="text/css">
    .element {
      background: none repeat scroll 0 0 #EEEEFF;
      border-left: 0.25em solid #9999FF;
      color: black;
      margin: 0 0 1em 0.15em;
      padding: 0 1em 0.25em 0.75em;
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>

  <section id='abstract'>

    <p>This is an addendum to the specification of HTML5 forms extending the 
    abilities of configuring HTTP requests through HTML markup.</p>

  </section>

  <section class="informative">

    <h2>Introduction</h2>

    <p>The use of forms in HTML provide a declerative interface for capturing 
    user input for interaction with remote web services over the HTTP protocol.
    </p>

    <p>This specification builds upon the standarization of XMLHttpRequest 
    [[XHR]] by extending the functionality available to configure HTTP requests 
    in JavaScript interfaces to declerative form attributes and controls.</p>

		<p>The set of changes herein remove the restriction on HTTP methods allowing 
    both the use of the common HTTP methods PUT and DELETE, while also allowing 
    HTTP extension-methods for unstandarized private or experimental use.</p>

	  <p>A new <code>payload</code> submission attribute is introduced to enable 
    the configuration of the HTTP message through form controls. This allows new 
    flexibility in the configuration of URL query parameters, HTTP headers and 
    message data through input controls.</p>

    <p>This specification extends the use of named form attributes for 
    configuring HTTP Authentication parameters managed by the User Agent. This 
    introduces the ability for declarative "login" and "logout" forms and 
    provides an alternative to the use of cookies for session continuation.</p>

    <p>The sub-sections of this document correlate to the sections of the HTML5 
    [[!HTML5]] specification and identify the set of changes with the exception 
    of nominal referential updates.</p>

  </section>

  <section>

    <h2>Form <code>method</code> Attribute</h2>

    <div id="form-method-spec">

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#attributes-common-to-form-controls">
          <span>4.10.19 Attributes common to form controls</span>
        </a>
      </p>

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#form-submission">
          4.10.19.6 Form submission
        </a>
      </p>

      <div class="incoming">

        <p>The <dfn title="attr-fs-method"><code>method</code></dfn> and
        <dfn title="attr-fs-formmethod"><code>formmethod</code></dfn>
        content attributes, if specified, must be a valid HTTP 
        method or extension-method [[!HTTP11]] with the exception of the 
        following keywords and states which are forbidden:</p>

        <ul>

           <li>The keyword <dfn
          title="attr-fs-method-CONNECT-keyword"><code>connect</code></dfn>, 
          mapping to the state <dfn title="attr-fs-method-CONNECT">CONNECT</dfn>, 
          indicating the HTTP CONNECT method.</li>

          <li>The keyword <dfn
          title="attr-fs-method-TRACE-keyword"><code>trace</code></dfn>, 
          mapping to the state <dfn title="attr-fs-method-TRACE">TRACE</dfn>, 
          indicating the HTTP TRACE method.</li>

          <li>The keyword <dfn
          title="attr-fs-method-TRACK-keyword"><code>track</code></dfn>, 
          mapping to the state <dfn title="attr-fs-method-TRACK">TRACK</dfn>, 
          indicating the HTTP TRACK method.</li>

        </ul>

        <p>The <i>invalid value default</i> for these attributes is the
        <span title="attr-fs-method-GET">GET</span> state. (There is no
        <i>missing value default</i>.)</p>

        <p>The <dfn title="concept-fs-method">method</dfn> of an element is
        the corresponding state. If the element is a <span
        title="concept-submit-button">submit button</span> and has a <code
        title="attr-fs-formmethod">formmethod</code> attribute, then the
        element's <span title="concept-fs-method">method</span> is that
        attribute's state; otherwise, it is the <span>form owner</span>'s
        <code title="attr-fs-method">method</code> attribute's state.</p>
          
      </div>

    </div>

  </section>

  <section>

    <h2>Submission <code>payload</code> Attribute</h2>

    <div id="payload-attribute-spec">        

      <p>  
        <a href="http://www.w3.org/TR/html5/forms.html#forms">
          4.10 Forms
        </a>
      </p>

      <div class="incoming">
      
                <dl class="element">
                    <dt><span title="element-dfn-categories">Categories</span>:</dt>
                    <dd><span>Submittable content</span>.</dd>
                    <dt><span title="element-dfn-attributes">Content attributes</span>:</dt>
                    <dd><code title="attr-fe-payload">payload</code></dd>
                    <dt><span title="element-dfn-dom">DOM interface</span>:</dt>
                    <dd><dd><pre>interface <dfn>&lt;HTMLSubmittableElement&gt;</dfn> {
    attribute DOMString <span title="dom-fe-payload">payload</span>;
};</pre></dd>
                </dl>

      </div>

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#attributes-common-to-form-controls">
          4.10.19 Attributes common to form controls
        </a>
      </p>

      <p>
        <a href="#payload-attribute-spec">
          &lt;ADDENDUM&gt; Binding form controls: the <code>payload</code> attribute
        </a>
      </p>

      <div class="incoming">

        <p>The <dfn title="attr-fs-payload"><code>payload</code></dfn> attribute 
        on a form control is used to specify the binding of the control to a 
        scheme data set for form submission. The attribute is an enumerated 
        attribute with the following keywords and states:</p>

        <ul>

          <li>The keyword <dfn
          title="attr-fs-payload-action-keyword"><code>_action</code></dfn>, 
          mapping to the state <dfn id="attr-fs-payload-ACTION">ACTION</dfn>, 
          indicating that the value is a member of the form action set.</li>

          <li>The keyword <dfn
          title="attr-fs-payload-header-keyword"><code>_header</code></dfn>, 
          mapping to the state <dfn id="attr-fs-payload-HEADER">HEADER</dfn>, 
          indicating that the value is a member of the form header set.</li>

          <li>The keyword <dfn
          title="attr-fs-payload-body-keyword"><code>_body</code></dfn>,
          mapping to the state <dfn id="attr-fs-payload-BODY">BODY</dfn>, 
          indicating that the value is a member of the form body set.</li>

        </ul>

        <p>If the element does not have such an attribute then the value is 
        determined within the context of the <code>form</code>, or the 
        <var>submitter</var> during <span>form submission</span>:</p>

        <ul>

          <li>
            <p>If the scheme is <code>http(s)</code> and the <var>method</var> is 
            HEAD, GET, OPTIONS or DELETE then the <code>payload</code> is the 
            <a href="#attr-fs-payload-ACTION">ACTION</a> state.</p>
          </li>

          <li>
            <p>If the scheme is <code>http(s)</code> and the <var>method</var> is 
            PUT, POST, PATCH or an extension-method then the <code>payload</code> 
            is the <a href="#attr-fs-payload-BODY">BODY</a> state.</p>
          </li>

          <li>
            <p>For the <code>data</code> and <code>mailto</code> schemes the 
            missing value default is the <a href="#attr-fs-payload-BODY">
            BODY</a> state.</p>
          </li>

        </ul>

      </div>

    </div>

  </section>

  <section>

    <h2>Form Controls for HTTP Authentication</h2>

    <div id="httpauth-control-spec">

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#attributes-common-to-form-controls">
          4.10.19 Attributes common to form controls
        </a>
      </p>

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#naming-form-controls">
          4.10.19.1 Naming form controls: the <code title="attr-fe-name">name</code> attribute
        </a>
      </p>

      <div class="incoming">

        <p>The <dfn title="attr-fe-name"><code>name</code></dfn> content
        attribute gives the name of the form control, as used in <span>form
        submission</span> and in the <code>form</code> element's <code
        title="dom-form-elements">elements</code> object. If the attribute
        is specified, its value must not be the empty string.</p>

        <p>Any non-empty value for <code title="attr-form-name">name</code>
        is allowed, but the names 
        "<code title="attr-fe-name-isindex">isindex</code>",
        "<code title="attr-fe-name-charset">_charset_</code>",
        "<code title="attr-fe-name-username">_username_</code>",
        "<code title="attr-fe-name-password">_password_</code>" and
        "<code title="attr-fe-name-logout">_logout_</code>" are special:</p>

        <dl>

          <dt><dfn title="attr-fe-name-isindex"><code>isindex</code></dfn></dt>
          <dd>
            <p>This value, if used as the name of a <span
            title="attr-input-type-text">Text</span> control that is the first
            control in a form that is submitted using the <code
            title="attr-fs-enctype-urlencoded">application/x-www-form-urlencoded</code>
            mechanism, causes the submission to only include the value of this
            control, with no name.</p>
          </dd>

          <dt><dfn title="attr-fe-name-charset"><code>_charset_</code></dfn></dt>
          <dd>
            <p>This value, if used as the name of a <span
            title="attr-input-type-hidden">Hidden</span> control with no <code
            title="attr-input-value">value</code> attribute, is automatically
            given a value during submission consisting of the submission
            character encoding.</p>
          </dd>

          <dt><dfn title="attr-fe-name-username"><code>_username_</code></dfn></dt>
          <dd>
            <p>This value, if used as the name of a <span
            title="attr-input-type-text">Text</span> or <span
            title="attr-input-type-email">Email</span> control, is used as a 
            named parameter for a HTTP Authentication scheme 
            [[!HTTPAUTH]] if supported by the user agent  and the form does not 
            contain an <code>Authorization</code> request header.</p>
          </dd>

          <dt><dfn title="attr-fe-name-password"><code>_password_</code></dfn></dt>
          <dd>
            <p>This value, if used as the name of a <span
            title="attr-input-type-password">Password</span> control, is used as 
            a named parameter for a HTTP Authentication scheme 
            [[!HTTPAUTH]] if supported by the user agent and the form does not 
            contain an <code>Authorization</code> request header.</p>
          </dd>

          <dt><dfn title="attr-fe-name-logout"><code>_logout_</code></dfn></dt>
          <dd>
            <p>This value, if used as the name of a <span
            title="attr-input-type-hidden">Hidden</span> control, causes a User 
            Agent which supports HTTP Authentication and reuses 
            authenticated credentials across requests to clear any credentials for the 
            protection space on receiving a HTTP success code (2XX)  response 
            [[!HTTPAUTH]].</p>
          </dd>

        </dl>

        <div class="impl">

          <p>The <dfn title="dom-fe-name"><code>name</code></dfn> IDL
          attribute must <span>reflect</span> the <code
          title="attr-fe-name">name</code> content attribute.</p>

        </div>

      </div>

    </div>

  </section>

  <section>

    <h2>Form Submission</h2>

    <div id="form-submission-spec">

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#form-submission-0">
          <span>4.10.22 Form submission</span>
        </a>
      </p>

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#form-submission-algorithm">
          4.10.22.3 Form submission algorithm
        </a>
      </p>

      <div class="incoming">

        <p>When a <code>form</code> element <var title="">form</var> is <dfn
        title="concept-form-submit">submitted</dfn> from an element <var
        title="">submitter</var> (typically a button), optionally with a
        <var title="">submitted from <code
        title="dom-form-submit">submit()</code> method</var> flag set, the
        user agent must run the following steps:</p>

        <ol>

          <li><p>Let <var title="">form document</var> be the <var
          title="">form</var>'s <code>Document</code>.</p></li>

          <li id="sandboxSubmitBlocked"><p>If <var title="">form
          document</var> has no associated <span>browsing context</span> or
          its <span>active sandboxing flag set</span> has its
          <span>sandboxed forms browsing context flag</span> set, then abort
          these steps without doing anything.</p></li>

          <li><p>Let <var title="">form browsing context</var> be the
          <span>browsing context</span> of <var title="">form
          document</var>.</p></li>

          <!-- lock (all the following steps are skipped if called from submit() - see unlock step below) -->

          <li><p>If the <var title="">submitted from <code
          title="dom-form-submit">submit()</code> method</var> flag is not
          set, and the <var title="">submitter</var> element's <span
          title="concept-fs-novalidate">no-validate state</span> is false,
          then <span>interactively validate the constraints</span> of <var
          title="">form</var> and examine the result: if the result is
          negative (the constraint validation concluded that there were
          invalid fields and probably informed the user of this) then abort
          these steps.</p></li>

          <li><p>If the <var title="">submitted from <code
          title="dom-form-submit">submit()</code> method</var> flag is not
          set, then <span>fire a simple event</span> that is cancelable named
          <code title="event-submit">submit</code>, at <var
          title="">form</var>. If the event's default action is prevented
          (i.e. if the event is canceled) then abort these steps. Otherwise,
          continue (effectively the default action is to perform the
          submission).</p></li>

          <!-- if you add any steps between the "lock" and "unlock" lines,
          make sure to update the step immediately before the "lock" line -->

          <!-- unlock -->

          <li><p>Let <var title="">action</var> be the result of
          <span>constructing the form action</span> for <var
          title="">form</var> in the context of <var
          title="">submitter</var>.</p></li>

          <li>

            <p>If <var title="">action</var> is the empty string, let <var
            title="">action</var> be <span>the document's address</span> of
            the <var title="">form document</var>.</p>

            <p class="note">This step is a <span>willful violation</span> of
            RFC 3986, which would require base URL processing here. This
            violation is motivated by a desire for compatibility with legacy
            content. <a href="#refsRFC3986">[RFC3986]</a></p>

            <!-- Don't ask me why. But that's what IE does. It even treats
            action="" differently from action=" " or action="#" (the latter
            two resolve to the base URL, the first one resolves to the doc
            URL). And other browsers concur. It is even required, see e.g.
              http://bugs.webkit.org/show_bug.cgi?id=7763
              https://bugzilla.mozilla.org/show_bug.cgi?id=297761
            -->

          </li>

          <li><p><span title="resolve a url">Resolve</span> the
          <span>URL</span> <var title="">action</var>, relative to the <var
          title="">submitter</var> element. If this fails, abort these
          steps. Otherwise, let <var title="">action</var> be the resulting
          <span>absolute URL</span>.</p></li>

          <li><p>Let <var title="">scheme</var> be the <span
          title="url-scheme">&lt;scheme&gt;</span> of the resulting
          <span>absolute URL</span>.</p></li>

          <li><p>Let <var title="">method</var> be the <var
          title="">submitter</var> element's <span
          title="concept-fs-method">method</span>.</p></li>

          <li><p>Let <var title="">form action set</var> be the result of
          <span>constructing a form payload set</span> for <var
          title="">form</var> in the context of <var
          title="">submitter</var> with payload type <a 
          href="#attr-fs-payload-ACTION">ACTION</a>.</p></li>

          <li><p>Let <var title="">form header set</var> be the result of
          <span>constructing a form payload set</span> for <var
          title="">form</var> in the context of <var
          title="">submitter</var> with payload type <a 
          href="#attr-fs-payload-HEADER">HEADER</a>.</p></li>

          <li><p>Let <var title="">form body set</var> be the result of
          <span>constructing a form payload set</span> for <var
          title="">form</var> in the context of <var
          title="">submitter</var> with payload type <a 
          href="#attr-fs-payload-BODY">BODY</a>.</p></li>

          <li><p>Let <var title="">enctype</var> be the <var
          title="">submitter</var> element's <span
          title="concept-fs-enctype">enctype</span>.</p></li>

          <li><p>Let <var title="">target</var> be the <var
          title="">submitter</var> element's <span
          title="concept-fs-target">target</span>.</p></li>

          <li><p>If the user indicated a specific <span>browsing
          context</span> to use when submitting the form, then let <var
          title="">target browsing context</var> be that <span>browsing
          context</span>. Otherwise, apply <span>the rules for choosing a
          browsing context given a browsing context name</span> using <var
          title="">target</var> as the name and <var title="">form browsing
          context</var> as the context in which the algorithm is executed,
          and let <var title="">target browsing context</var> be the
          resulting <span>browsing context</span>.</p></li>

          <li><p>If <var title="">target browsing context</var> was created
          in the previous step, or if the <var title="">form document</var>
          has not yet <span>completely loaded</span>, then let <var
          title="">replace</var> be true. Otherwise, let it be
          false.</p></li>

          <li>

            <p>Otherwise, select the appropriate behavior based
            on the value of <var title="">scheme</var> and jump to the steps 
            therein.</p>

            <p>If <var title="">scheme</var> is not one of those listed in
            below, then the behavior is not defined by this
            specification. User agents should, in the absence of another
            specification defining this, act in a manner analogous to that
            defined in this specification for similar schemes.</p>

            <p>The behaviors are as follows:</p>

            <dl>

              <dt><dfn title="submit-http">Submit <code title="">http(s)</code></dfn></dt>

              <dd>

                <div class="note">
                  <p>If <var title="">method</var> is anything but GET or POST, 
                  and the <span>origin</span> of <var title="">action</var>
                  is not the <span>same origin</span> as that of <var
                  title="">form document</var>, then user agents may abort 
                  these steps, or perform a cross-origin pre-flight verification 
                  [[CORS]].</p>
                </div>

                <p>Let <var title="">query</var> be the result of encoding the
                <var title="">form action set</var> using the <span><code
                title="">application/x-www-form-urlencoded</code> encoding
                algorithm</span>, interpreted as a US-ASCII string.</p>

                <!-- by this point we've already tried to resolve the URL, so we
                know we can parse it -->

                <p>Let <var title="">destination</var> be a new <span>URL</span>
                that is equal to the <var title="">action</var> except that its
                <span title="url-query">&lt;query&gt;</span> component is
                replaced by <var title="">query</var> (adding a U+003F QUESTION
                MARK character (?) if appropriate).</p>

                <p>Let <var title="">request headers</var> be a list of HTTP 
                header names and and corresponding header values, initially empty.</p>

                <p>Loop: For each <var title="">entry</var> in <var title="">
                form header set</var>, run the following substeps:</p>

                <ol>
  
                  <li><p>If  the <var title="">name</var> of the <var title="">entry</var>
                  does not match the <a href="http://tools.ietf.org/html/rfc2616/#section-4.2">field-name</a> 
                  production [[!HTTP11]], then skip these substeps.</p></li>
                  
                  <li><p>If  the <var title="">value</var> of the <var title="">entry</var>
                  does not match the <a href="http://tools.ietf.org/html/rfc2616/#section-4.2">field-value</a> 
                  production [[!HTTP11]], then skip these substeps.</p></li>
  
                  <li>
  
                    <p>If the <var title="">name</var> of the <var title="">entry</var>
                    is a case-insensitive match for any of the following set of 
                    forbidden headers, then the skip these substeps:</p>
  
                    <ul>
                      <li>Accept-Charset</li>
                      <li>Accept-Encoding</li>
                      <li>Access-Control-Request-Headers</li>
                      <li>Access-Control-Request-Method</li>
                      <li>Connection</li>
                      <li>Content-Length</li>
                      <li>Cookie</li>
                      <li>Cookie2</li>
                      <li>Date</li>
                      <li>DNT</li>
                      <li>Expect</li>
                      <li>Host</li>
                      <li>Keep-Alive</li>
                      <li>Origin</li>
                      <li>Referer</li>
                      <li>TE</li>
                      <li>Trailer</li>
                      <li>Transfer-Encoding</li>
                      <li>Upgrade</li>
                      <li>User-Agent</li>
                      <li>Via</li>
                    </ul>
  
                    <p>...or if the start of <var title="">name</var> is a 
                    case-insensitive match for <code>Proxy-</code> or <code>
                    Sec-</code> (including when header is just <code>Proxy-</code> 
                    or <code>Sec-</code>).</p>
  
                  </li>
  
                  <li>
  
                    <p>If the list of <var title="">request headers</var> does not 
                    contain a case-insensitive match of the <var title="">name</var> 
                    of the <var title="">entry</var>, then append the 
                    <var title="">name</var> and <var title="">value</var> to the 
                    list of <var title="">request headers</var>.</p>
  
                  </li>
  
                  <li>
  
                    <p>Otherwise, combine  the <var title="">value</var> of the matched 
                    <var title="">request header</var> with the <var title="">value</var>
                    of the <var title="">entry</var> using a single U+002C COMMA 
                    character (,) as separator [[!HTTP11]].</p>
  
                  </li>
  
                </ol>

                <p>Let <var title="">request username</var> be the value of the 
                first control in the <var title="">form</var> with name 
                "<code>_username_</code>" and with type "<code>text</code>" or 
                "<code>email</code>", or null if no such element exists.</p>
  
                <p>Let <var title="">request password</var> be the value of the 
                first control in the <var title="">form</var> with name 
                "<code>_password_</code>" and with type "<code>password</code>", 
                or null if no such element exists.</p>
  
                <p>If the list of <var title="">request headers</var> does not 
                contain an <code>Authorization</code> header and the resource was 
                returned with an <code>WWW-Authenticate</code> response header, 
                the user agent should answer the strongest authentication 
                challenge using the <var title="">request username</var> and 
                <var title="">request password</var> as authentication scheme 
                parameters and add the header to the list of <var title="">
                request headers</var>.<p>
  
                <p>Let <var title="">entity body</var> be the result of encoding
                the <var title="">form body set</var> using the
                <span>appropriate form encoding algorithm</span>.</p>
  
                <p>Let <var title="">MIME type</var> be determined as
                follows:</p>

                <dl>
  
                  <dt>If <var title="">enctype</var> is <code title="attr-fs-enctype-urlencoded">application/x-www-form-urlencoded</code></dt>
  
                    <dd>Let <var title="">MIME type</var> be "<code
                    title="">application/x-www-form-urlencoded</code>".</dd>
  
                    <dt>If <var title="">enctype</var> is <code title="attr-fs-enctype-formdata">multipart/form-data</code></dt>
  
                    <dd>Let <var title="">MIME type</var> be the concatenation of
                    the string "<code title="">multipart/form-data;</code>", a
                    U+0020 SPACE character, the string "<code
                    title="">boundary=</code>", and the <span><code
                    title="">multipart/form-data</code> boundary string</span>
                    generated by the <span><code
                    title="">multipart/form-data</code> encoding
                    algorithm</span>.</dd>
  
                    <dt>If <var title="">enctype</var> is <code title="attr-fs-enctype-text">text/plain</code></dt>
  
                    <dd>Let <var title="">MIME type</var> be "<code title="">text/plain</code>".</dd>
  
                  </dl>

                  <p><span>Navigate</span><!--DONAV form--> <var
                  title="">target browsing context</var> to <var
                  title="">action</var> using the HTTP method given by <var
                  title="">method</var> applying any additional <var title="">
                  request headers</var> and with <var title="">entity body</var>
                  as the entity body, of type <var title="">MIME type</var>. If
                  <var title="">replace</var> is true, then <var title="">target
                  browsing context</var> must be navigated with <span>replacement
                  enabled</span>.</p>
  
                  <p>If the user agent supports HTTP Authentication and 
                  <code>Authorization</code> is not in the list of <var title="">
                  request headers</var>, it should respond to a <code>401 Unauthorized</code>
                  authentication challenge using the <var title="">request username
                  </var> and <var title="">request password</var> as authentication 
                  scheme parameters.</p>

                  <p>If the <var title="">request username</var> is null and <var 
                  title="">request password</var> is null the user agent should 
                  prompt the end user for authentication challenge parameters.</p>

                </dd>

                <dt><dfn title="submit-data"> Submit <code title="">data</code></dfn></dt>

                <dd>

                  <p>Let <var title="">data</var> be the result of encoding the
                  <var title="">form body set</var> using the <span>appropriate
                  form encoding algorithm</span>.</p>

                  <p>If <var title="">action</var> contains the string "<code
                  title="">%%%%</code>" (four U+0025 PERCENT SIGN characters),
                  then %-escape all bytes in <var title="">data</var> that, if
                  interpreted as US-ASCII, do not match the <code
                  title="">unreserved</code> production in the URI Generic Syntax,
                  and then, treating the result as a US-ASCII string, further
                  %-escape all the U+0025 PERCENT SIGN characters in the resulting
                  string and replace the first occurrence of "<code
                  title="">%%%%</code>" in <var title="">action</var> with the
                  resulting double-escaped string. <a
                  href="#refsRFC3986">[RFC3986]</a></p>

                  <p>Otherwise, if <var title="">action</var> contains the string
                  "<code title="">%%</code>" (two U+0025 PERCENT SIGN characters
                  in a row, but not four), then %-escape all characters in <var
                  title="">data</var> that, if interpreted as US-ASCII, do not
                  match the <code title="">unreserved</code> production in the URI
                  Generic Syntax, and then, treating the result as a US-ASCII
                  string, replace the first occurrence of "<code
                  title="">%%</code>" in <var title="">action</var> with the
                  resulting escaped string. <a
                  href="#refsRFC3986">[RFC3986]</a></p>

                  <p><span>Navigate</span><!--DONAV form--> <var title="">target
                  browsing context</var> to the potentially modified <var
                  title="">action</var> (which will be a <span title="data
                  protocol"><code title="">data:</code> URL</span>). If <var
                  title="">replace</var> is true, then <var title="">target
                  browsing context</var> must be navigated with <span>replacement
                  enabled</span>.</p>

                </dd>

                <dt><dfn title="submit-mailto">Submit <code title="">mailto</code></dfn></dt>
             
              <dd>

                <p>Let <var title="">destination</var> have the same value as
                <var title="">action</var>.</p>

                <p>Let <var title="">recipients</var> be the resulting encoding the
                <var title="">form action set</var> by concatenating the elements
                using a U+002C COMMA character (,) deliminator.</p>

                <p>Replace occurrences of U+002B PLUS SIGN characters (+) in
                <var title="">recipients</var> with the string "<code
                title="">%20</code>".</p>
  
                <p>If <var title="">recipients</var> is not the empty string, let 
                <var title="">destination</var> consist of all the characters from 
                the first character in <var title="">destination</var> to the 
                character immediately before the first U+003F QUESTION MARK 
                character (?), if any, or the end of the string if there are none.</p>

                <p>Append <var title="">recipients</var> to <var
                title="">destination</var>.</p>
  
                <p>Let <var title="">headers</var> be the resulting encoding the
                <var title="">form header set</var> using the <span><code
                title="">application/x-www-form-urlencoded</code> encoding
                algorithm</span>, interpreted as a US-ASCII string.</p>
  
                <p>Replace occurrences of U+002B PLUS SIGN characters (+) in
                <var title="">headers</var> with the string "<code
                title="">%20</code>".</p>
  
                <p>If <var title="">destination</var> does not contain a U+003F
                QUESTION MARK character (?), append a single U+003F QUESTION
                MARK character (?) to <var
                title="">destination</var>. Otherwise, append a single U+0026
                AMPERSAND character (&amp;).</p>

                <p>Append <var title="">headers</var> to <var
                title="">destination</var>.</p>
  
                <p>Let <var title="">body</var> be the resulting encoding the
                <var title="">form body set</var> using the <span>appropriate
                form encoding algorithm</span> and then %-escaping all the bytes
                in the resulting byte string that, when interpreted as US-ASCII,
                do not match the <code title="">unreserved</code> production in
                the URI Generic Syntax. <a href="#refsRFC3986">[RFC3986]</a></p>
    
                <p>If <var title="">destination</var> does not contain a U+003F
                QUESTION MARK character (?), append a single U+003F QUESTION
                MARK character (?) to <var
                title="">destination</var>. Otherwise, append a single U+0026
                AMPERSAND character (&amp;).</p>

                <p>Append the string "<code title="">body=</code>" to <var
                title="">destination</var>.</p>

                <p>Append <var title="">body</var>, interpreted as a US-ASCII
                string, to <var title="">destination</var>.</p>

                <p><span>Navigate</span><!--DONAV form--> <var title="">target
                browsing context</var> to <var title="">destination</var>. If
                <var title="">replace</var> is true, then <var title="">target
                browsing context</var> must be navigated with <span>replacement
                enabled</span>.</p>

              </dd>

            </dl>

            <p>The <dfn>appropriate form encoding algorithm</dfn> is
            determined as follows:</p>

            <dl>

              <dt>If <var title="">enctype</var> is <code 
              title="attr-fs-enctype-urlencoded">application/x-www-form-urlencoded</code></dt>

              <dd>Use the <span><code
              title="">application/x-www-form-urlencoded</code> encoding
              algorithm</span>.</dd>

              <dt>If <var title="">enctype</var> is <code 
              title="attr-fs-enctype-formdata">multipart/form-data</code></dt>

              <dd>Use the <span><code
              title="">multipart/form-data</code> encoding
              algorithm</span>.</dd>

              <dt>If <var title="">enctype</var> is <code 
              title="attr-fs-enctype-text">text/plain</code></dt>

              <dd>Use the <span><code title="">text/plain</code> encoding
              algorithm</span>.</dd>

            </dl>

          </li>

        </ol>

      </div>

      <p>
        <a href="http://www.w3.org/TR/html5/forms.html#constructing-form-data-set">
          4.10.22.4 Constructing a form payload set
        </a>
      </p>

      <div class="incoming">

        <p>The algorithm to <dfn title="constructing a form payload
        set">construct a form payload set</dfn> for a form <var
        title="">form</var> optionally in the context of a submitter <var
        title="">submitter</var> is as follows. If not specified otherwise,
        <var title="">submitter</var> is null.</p>

        <ol>

          <li><p>Let <var title="">payload</var> be the payload type whose 
          data set is to be constructed.</p></li>

          <li><p>Let <var title="">controls</var> be a list of all the <span
          title="category-submit">submittable elements</span> whose
          <span>form owner</span> is <var title="">form</var>, in <span>tree
          order</span>.</p></li>

          <li><p>Let the <var title="">form payload set</var> be a list of
          name-value-type tuples, initially empty.</p></li>

          <li>

            <p><i>Loop</i>: For each element <var title="">field</var> in <var
            title="">controls</var>, in <span>tree order</span>, run the
            following substeps:</p>

            <ol>

              <li>

                <p>If any of the following conditions are met, then skip these
                substeps for this element:</p>

                <ul>

                  <li>The <var title="">field</var> element has
                  <code>payload</code> attribute state which is not equal to 
                  <var title="">payload</var>.</li>

                  <li>The <var title="">field</var> element has a
                  <code>datalist</code> element ancestor.</li>

                  <li>The <var title="">field</var> element is <span
                  title="concept-fe-disabled">disabled</span>.</li>

                  <li>The <var title="">field</var> element is a <span
                  title="concept-button">button</span> but it is not <var
                  title="">submitter</var>.</li>

                  <li>The <var title="">field</var> element is an <code>input</code> 
                  element whose <code>name</code> attribute value is  
                  "<a href="#attr-fe-name-username"><code>_username_</code></a>" or
                  "<a href="#attr-fe-name-password"><code>_password_</code></a>".</li>

                  <li>The <var title="">field</var> element is an
                  <code>input</code> element whose <code
                  title="attr-input-type">type</code> attribute is in the <span
                  title="attr-input-type-checkbox">Checkbox</span> state and
                  whose <span title="concept-fe-checked">checkedness</span> is
                  false.</li>

                  <li>The <var title="">field</var> element is an
                  <code>input</code> element whose <code
                  title="attr-input-type">type</code> attribute is in the <span
                  title="attr-input-type-radio">Radio Button</span> state and
                  whose <span title="concept-fe-checked">checkedness</span> is
                  false.</li>

                  <li>The <var title="">field</var> element is not an
                  <code>input</code> element whose <code
                  title="attr-input-type">type</code> attribute is in the <span
                  title="attr-input-type-image">Image Button</span> state, and
                  either the <var title="">field</var> element does not have a
                  <code title="attr-fe-name">name</code> attribute specified, or
                  its <code title="attr-fe-name">name</code> attribute's value is
                  the empty string.</li>

                  <li>The <var title="">field</var> element is an
                  <code>object</code> element that is not using a
                  <span>plugin</span>.</li>

                </ul>

                <p>Otherwise, process <var title="">field</var> as follows:</p>

              </li>

              <li><p>Let <var title="">type</var> be the value of the <code
              title="">type</code> IDL attribute of <var
              title="">field</var>.</p></li> <!-- if the field is an <object>
              element, this will get ignored. -->

              <li>

                <p>If the <var title="">field</var> element is an
                <code>input</code> element whose <code
                title="attr-input-type">type</code> attribute is in the <span
                title="attr-input-type-image">Image Button</span> state,
                then run these further nested substeps:</p>

                <ol>

                  <li><p>If the <var title="">field</var> element has a <code
                  title="attr-fe-name">name</code> attribute specified and its
                  value is not the empty string, let <var title="">name</var> be
                  that value followed by a single U+002E FULL STOP character (.).
                  Otherwise, let <var title="">name</var> be the empty
                  string.</p></li>

                  <li><p>Let <var title="">name<sub title="">x</sub></var> be the
                  string consisting of the concatenation of <var
                  title="">name</var> and a single U+0078 LATIN SMALL LETTER X
                  character (x).</p></li>

                  <li><p>Let <var title="">name<sub title="">y</sub></var> be the
                  string consisting of the concatenation of <var
                  title="">name</var> and a single U+0079 LATIN SMALL LETTER Y
                  character (y).</p></li>

                  <li><p>The <var title="">field</var> element is <var
                  title="">submitter</var>, and before this algorithm was invoked
                  the user <span
                  title="concept-input-type-image-coordinate">indicated a
                  coordinate</span>. Let <var title="">x</var> be the <var
                  title="">x</var>-component of the coordinate selected by the
                  user, and let <var title="">y</var> be the <var
                  title="">y</var>-component of the coordinate selected by the
                  user.</p></li>

                  <li><p>Append an entry to the <var title="">form payload set</var>
                  with the name <var title="">name<sub title="">x</sub></var>,
                  the value <var title="">x</var>, and the type <var
                  title="">type</var>.</p></li>

                  <li><p>Append an entry to the <var title="">form payload set</var>
                  with the name <var title="">name<sub title="">y</sub></var> and
                  the value <var title="">y</var>, and the type <var
                  title="">type</var>.</p></li>

                  <li><p>Skip the remaining substeps for this element: if there
                  are any more elements in <var title="">controls</var>, return
                  to the top of the <i>loop</i> step, otherwise, jump to the
                  <i>end</i> step below.</p></li>

                </ol>

              </li>

              <li><p>Let <var title="">name</var> be the value of the <var
              title="">field</var> element's <code
              title="attr-fe-name">name</code> attribute.</p></li>

              <li><p>If the <var title="">field</var> element is a
              <code>select</code> element, then for each <code>option</code>
              element in the <code>select</code> element whose <span
              title="concept-option-selectedness">selectedness</span> is true,
              append an entry to the <var title="">form payload set</var> with the
              <var title="">name</var> as the name, the <span
              title="concept-option-value">value</span> of the
              <code>option</code> element as the value, and <var
              title="">type</var> as the type.</p></li>

              <li>

                <p>Otherwise, if the <var title="">field</var> element is an
                <code>input</code> element whose <code
                title="attr-input-type">type</code> attribute is in the <span
                title="attr-input-type-checkbox">Checkbox</span> state or the
                <span title="attr-input-type-radio">Radio Button</span> state,
                then run these further nested substeps:</p>

                <ol>

                  <li><p>If the <var title="">field</var> element has a <code
                  title="attr-input-value">value</code> attribute specified, then
                  let <var title="">value</var> be the value of that attribute;
                  otherwise, let <var title="">value</var> be the string
                  "<code title="">on</code>".</p></li>

                  <li><p>Append an entry to the <var title="">form payload set</var>
                  with <var title="">name</var> as the name, <var
                  title="">value</var> as the value, and <var title="">type</var>
                  as the type.</p></li>

                </ol>

              </li>

              <li><p>Otherwise, if the <var title="">field</var> element is an
              <code>input</code> element whose <code
              title="attr-input-type">type</code> attribute is in the <span
              title="attr-input-type-file">File Upload</span> state, then for
              each file <span
              title="concept-input-type-file-selected">selected</span> in the
              <code>input</code> element, append an entry to the <var
              title="">form payload set</var> with the <var title="">name</var> as
              the name, the file (consisting of the name, the type, and the
              body) as the value, and <var title="">type</var> as the type. If
              there are no <span
              title="concept-input-type-file-selected">selected files</span>,
              then append an entry to the <var title="">form payload set</var>
              with the <var title="">name</var> as the name, the empty string
              as the value, and <code>application/octet-stream</code> as the
              type.</p></li>
              <!-- https://bugzilla.mozilla.org/show_bug.cgi?id=529859 -->

              <li><p>Otherwise, if the <var title="">field</var> element is an
              <code>object</code> element: try to obtain a form submission
              value from the <span>plugin</span><!-- using NPAPI's
              NPP_GetValue() entry point with the NPPVformValue variable -->,
              and if that is successful, append an entry to the <var
              title="">form payload set</var> with <var title="">name</var> as the
              name, the returned form submission value as the value, and the
              string "<code title="">object</code>" as the type.</p></li>

              <li><p>Otherwise, append an entry to the <var title="">form payload
              set</var> with <var title="">name</var> as the name, the <span
              title="concept-fe-value">value</span> of the <var
              title="">field</var> element as the value, and <var
              title="">type</var> as the type.</p></li>

              <li>

                <p>If the element has a <code
                title="attr-fe-dirname">dirname</code> attribute, and that
                attribute's value is not the empty string, then run these
                substeps:</p>

                <ol>

                  <li><p>Let <var title="">dirname</var> be the value of the
                  element's <code title="attr-fe-dirname">dirname</code>
                  attribute.</p></li>

                  <li><p>Let <var title="">dir</var> be the string "<code
                  title="">ltr</code>" if <span>the directionality</span> of the
                  element is '<span title="concept-ltr">ltr</span>', and "<code
                  title="">rtl</code>" otherwise (i.e. when <span>the
                  directionality</span> of the element is '<span
                  title="concept-rtl">rtl</span>').</p></li>

                  <li><p>Append an entry to the <var title="">form payload set</var>
                  with <var title="">dirname</var> as the name, <var
                  title="">dir</var> as the value, and the string "<code
                  title="">direction</code>" as the type.</p></li>

                </ol>

                <p class="note">An element can only have a <code
                title="attr-fe-dirname">dirname</code> attribute if it is a
                <code>textarea</code> element or an <code>input</code> element
                whose <code title="attr-input-type">type</code> attribute is in
                either the <span title="attr-input-type-text">Text</span> state
                or the <span title="attr-input-type-search">Search</span>
                state.</p>

              </li>

            </ol>

          </li>

          <li>

            <p><i>End</i>: For the name of each entry in the <var
            title="">form payload set</var>, and for the value of each entry in
            the <var title="">form payload set</var> whose type is not "<code
            title="">file</code>" or "<code title="">textarea</code>", replace
            every occurrence of a U+000D CARRIAGE RETURN (CR) character not
            followed by a U+000A LINE FEED (LF) character, and every
            occurrence of a U+000A LINE FEED (LF) character not preceded by a
            U+000D CARRIAGE RETURN (CR) character, by a two-character string
            consisting of a U+000D CARRIAGE RETURN U+000A LINE FEED (CRLF)
            character pair.</p>

            <p class="note">In the case of the <span
            title="concept-fe-value">value</span> of <code>textarea</code>
            elements, this newline normalization is already performed during
            the conversion of the control's <span
            title="concept-textarea-raw-value">raw value</span> into the
            control's <span title="concept-fe-value">value</span> (which also
            performs any necessary line wrapping). In the case of
            <code>input</code> elements <code
            title="attr-input-type">type</code> attributes in the <span
            title="attr-input-type-file">File Upload</span> state, the value
            is not normalized.</p>

          </li>

          <li><p>Return the <var title="">form payload set</var>.</p></li>

        </ol>

      </div>

    </div>

  </section>

  <section>

    <h2>Examples</h2>

    <section class="informative">
      <h3>HTTP PUT Form</h3>

      <p>This form is used to updated an existing resource with the new 
      content within the entity, but only if the entity has not been modified 
      since the current version:</p>

      <pre class="example">
          &lt;form action="http://www.example.com/cms/hogmanay" method="PUT"&gt;
              &lt;input name="If-Unmodified-Since" type="hidden" value="Tue, 1 Jan 2013 12:00:00 GMT" payload="_header"/&gt;
              &lt;textarea name="content"&gt;

                  For auld lang syne, my dear,
                      For auld lang syne.
                  We'll tak a cup o' kindness yet,
                      For auld lang syne.

                  And there's a hand, my trusty fere!
                      And gie's a hand o' thine!
                  And we'll tak a right gude-willie waught,
                      For auld lang syne.

              &lt;/textarea&gt;
              &lt;button type="submit"&gt;Update&lt;/button&gt;
          &lt;/form&gt;
      </pre>
    </section>

    <section class="informative">
      <h3>HTTP DELETE Form</h3>

      <p>This form is used to delete a range of resources:</p>
      <pre class="example">
          &lt;form action="http://www.example.com/logs" method="DELETE"&gt;
              &lt;label for="since"&gt;Since&lt;/label&gt;
              &lt;input name="since" type="datetime"/&gt;
              &lt;button type="submit"&gt;Delete&lt;/button&gt;
          &lt;/form&gt;
      </pre>
    </section>

    <section class="informative">
      <h3>HTTP Authentication Login Form</h3>

      <p>This form provides the parameters for HTTP authentication from form 
      input controls:</p> 
      <pre class="example">
          &lt;form action="http://www.example.com/login" method="POST"&gt;
              &lt;label for="_username_"&gt;Username&lt;/label&gt;
              &lt;input name="_username_" type="text"/&gt;
              &lt;label for="_password_"&gt;Password&lt;/label&gt;
              &lt;input name="_password_" type="password"/&gt;
              &lt;button type="submit"&gt;Login&lt;/button&gt;
          &lt;/form&gt;
      </pre>
    </section>
    
    <section class="informative">
      <h3>HTTP Authentication Logout Form</h3>

      <p>This form sends a logout request to the server which may clear any 
      session cookies, and instructs the user agent to clear the 
      authentication cache:</p>
      <pre class="example">
          &lt;form action="http://www.example.com/logout" method="POST"&gt;
              &lt;input name="_logout_" type="hidden"/&gt;
              &lt;button type="submit"&gt;Logout&lt;/button&gt;
          &lt;/form&gt;
      </pre>
    </section>

    <section class="informative">
      <h3>Mailto Email Form</h3>

      <p>This form captures the inputs for sending an email through a mailto 
      URI: </p>
      <pre class="example">
          &lt;form action="mailto:"&gt;
              &lt;label for="to"&gt;To&lt;/label&gt;
              &lt;input name="to" type="email" payload="_action"/&gt;

              &lt;label for="cc"&gt;Cc&lt;/label&gt;
              &lt;input name="cc" type="email" payload="_header"/&gt;

              &lt;label for="bcc"&gt;Bcc&lt;/label&gt;
              &lt;input name="bcc" type="email" payload="_header"/&gt;

              &lt;label for="subject"&gt;Subject&lt;/label&gt;
              &lt;input name="subject" type="text" payload="_header"/&gt;

              &lt;label&gt;Content&lt;/label&gt;
              &lt;textarea size="50"/&gt;

              &lt;button type="submit"&gt;Send&lt;/button&gt;
          &lt;/form&gt;
      </pre>
    </section>

  </section>

  <section class='appendix'>
    <h2>Acknowledgements</h2>

    <p>Acknowledgements and thanks go to the following people for their efforts 
    which have contributed to this specification: </p>

    <ul>
      <li>Julian Reschke</li>
      <li>Mike Amundsen</li>
      <li>Dave Kok</li>
      <li>Ian Hickson</li>
      <li>Anne van Kesteren</li>
      <li>Ted O'Connor</li>
      <li>Nicholas Shanks</li>
      <li>HTML WG Chairs: Sam Ruby, Paul Cotton &amp; Maciej Stachowiak</li>
    </ul>

    <p>
      And of course, many thanks to Robin Berjon for making our lives so much easier with his 
      cool specification authoring tool.
    </p>
  </section>

</body>
</html>
